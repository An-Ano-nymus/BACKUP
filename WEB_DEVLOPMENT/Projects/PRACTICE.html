<!DOCTYPE HTML>
<html>
  <head>
    <meta name="robots" content="index, all" />
    <script src="https://www.webglearth.com/v2/api.js"></script>
    <title>WebGL Weather Earth API</title>
    <link rel="stylesheet" href="weather.css">
    <meta name="description" content="Free and open-source 3D digital globe for web and mobile devices. This example shows how to zoom to a certain zoom level, get the info about the zoom level, set position to a place, use the fly-to function, and add markers & polygons.">
    <script>
      var map;
      const API_KEY = "168771779c71f3d64106d8a88376808a";

      function init() {
        map = WE.map('map', {
          center: [36.057944835, -112.18688965],
          zoom: 3,
          dragging: true,
          scrollWheelZoom: true
        });

        var baselayer = WE.tileLayer('https://webglearth.github.io/webglearth2-offline/{z}/{x}/{y}.jpg', {
          tileSize: 256,
          bounds: [[-85, -180], [85, 180]],
          minZoom: 0,
          maxZoom: 16,
          attribution: 'WebGLEarth example',
          tms: true
        }).addTo(map);

        var json = {"profile": "mercator", "name": "Grand Canyon USGS", "format": "png", "bounds": [-112.26379395, 35.98245136, -112.10998535, 36.13343831], "minzoom": 10, "version": "1.0.0", "maxzoom": 16, "center": [-112.18688965, 36.057944835, 13], "type": "overlay", "description": "", "basename": "grandcanyon", "tilejson": "2.0.0", "sheme": "xyz", "tiles": ["http://tileserver.maptiler.com/grandcanyon/{z}/{x}/{y}.png"]};
        var grandcanyon = WE.tileLayerJSON(json);
        grandcanyon.addTo(map);

        grandcanyon.setOpacity(0.7);
        document.getElementById('opacity2').addEventListener('change', function(e) {
          grandcanyon.setOpacity(e.target.value);
        });
        WE.marker([json.center[1], json.center[0]]).addTo(map);

        map.on('mousemove', function(e) {
          document.getElementById('coords').innerHTML = e.latlng.lat + ', ' + e.latlng.lng;
        });

        map.on('click', function(e) {
          document.getElementById('addmarkers').disabled = true;

          var marker = WE.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
          console.log(e.latlng.lat + ', ' + e.latlng.lng);
          marker.bindPopup("<b>Hello world!</b>", {maxWidth: 120, closeButton: true});
        });
      }

      function addSomeMarkers() {
        document.getElementById('addmarkers').disabled = true;

        map.setView([51.505, 0], 5);
        var marker = WE.marker([51.5, -0.09]).addTo(map);
        marker.bindPopup("<b>Hello world!</b><br>I am a popup.<br /><span style='font-size:10px;color:#999'>Tip: Another popup is hidden in Cairo..</span>", {maxWidth: 150, closeButton: true}).openPopup();

        var marker2 = WE.marker([30.058056, 31.228889]).addTo(map);
        marker2.bindPopup("<b>Cairo</b><br>Yay, you found me!<br />Here, enjoy another polygon..", {maxWidth: 120, closeButton: false});

        var polygonA = WE.polygon([[50, 1], [51, 0.5], [50.5, 2.5]]).addTo(map);
        var polygonB = WE.polygon([[50, 3], [51, 2.5], [50.5, 4.5]], {
          color: '#ff0',
          opacity: 1,
          fillColor: '#f00',
          fillOpacity: 0.1,
          weight: 2
        }).addTo(map);

        var anotherPolygon = function(e) {
          WE.polygon([[30, 30], [29, 31], [30, 32], [32, 32], [31, 30]], {
            color: '#000',
            opacity: 1,
            fillColor: '#0f0',
            fillOpacity: 0.7,
            weight: 2
          }).addTo(map);
          marker2.off('click', anotherPolygon);
        };
        marker2.on('click', anotherPolygon);
      }

      function setZoom(zoom) {
        map.setZoom(zoom);
      }

      function getZoomLevel() {
        alert('Current zoom is: ' + Math.round(map.getZoom()));
      }

      function setPositionToEverest() {
        map.setView([27.988056, 86.925278]);
      }

      function getCurrentCenter() {
        alert(map.getCenter());
      }

      function flyToJapan() {
        map.fitBounds([[22, 122], [48, 154]]);
        map.panInsideBounds([[22, 122], [48, 154]], {heading: 90, tilt: 25, duration: 1});
      }

      function panTo(coords) {
        map.panTo(coords);
      }

      function getCoordinates() {
        return map.getCenter();
      }

      async function fetchWeatherInfo(weatherContentDiv) {
        const { lat, lng } = getCoordinates();

        try {
          const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${API_KEY}&units=metric`);

          if (!response.ok) {
            throw new Error(`Error fetching weather data: ${response.statusText}`);
          }

          const data = await response.json();
          renderWeatherInfo(data);

          weatherContentDiv.textContent = ''; 
        } catch (err) {
          console.error("Error:", err);
          weatherContentDiv.textContent = 'Error fetching weather data. Please try again later.';
        }
      }

      function renderWeatherInfo(data) {
        const cityName = document.querySelector('[data-cityName]');
        const countryFlag = document.querySelector('[data-countryFlag]'); 

        const description = document.querySelector('[data-weatherDesc]');
        const weatherIcon = document.querySelector('[data-weatherIcon]');
        const temp  = document.querySelector('[data-temp]');
        const windspeed = document.querySelector('[data-windspeed]');
        const humidity = document.querySelector('[data-humidity]');
        const clouds  = document.querySelector('[data-clouds]');

        if (!data || !data.name || !data.sys || !data.weather || !data.main || !data.wind || !data.clouds) {
          console.error('Missing weather data in API response.');
          return;
        }

        cityName.innerText = data.name;
        countryFlag.src = `https://flagcdn.com/144x108/${data.sys.country.toLowerCase()}.png`;
        description.innerText = data.weather[0].description; 
        weatherIcon.src = `http://openweathermap.org/img/w/${data.weather[0].icon}.png`;
        temp.innerText = `${data.main.temp.toFixed(2)}  °C`;
        windspeed.innerText = `${data.wind.speed.toFixed(2)} m/s`;
        humidity.innerText = `${data.main.humidity.toFixed(2)} %`;
        clouds.innerText = `${data.clouds.all.toFixed(2)} %`;
      }

      async function getLocationName(latitude, longitude) {
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`;

        try {
          const response = await fetch(url);
          const data = await response.json();
          console.log(data.display_name);
        } catch (error) {
          console.error(error);
        }
      }

      function WEATHER_FORECAST_BOX_CREATE() {
        const weatherForecastBox = document.createElement('div');
        weatherForecastBox.classList.add('weather-forecast-box');

        const closeButton = document.createElement('button');
        closeButton.classList.add('close-button');
        closeButton.textContent = 'X';
        closeButton.addEventListener('click', () => {
          weatherForecastBox.remove();
        });

        const weatherContent = document.createElement('div');
        weatherContent.classList.add('weather-content');
        weatherContent.textContent = 'Weather forecast content will go here';

        weatherForecastBox.appendChild(closeButton);
        weatherForecastBox.appendChild(weatherContent);

        document.body.appendChild(weatherForecastBox);

        fetchWeatherInfo(weatherContent);
      }
    </script>
  </head>
  <body onload="init()">
    <div id="map"></div>
    <div id="controls">
      <button onclick="addSomeMarkers()">Add some markers</button>
      <button id="addmarkers" onclick="addSomeMarkers()">Add markers again</button>
      <button onclick="setZoom(10)">Zoom to 10</button>
      <button onclick="getZoomLevel()">Get current zoom</button>
      <button onclick="setPositionToEverest()">Position to Everest</button>
      <button onclick="getCurrentCenter()">Get current center</button>
      <button onclick="flyToJapan()">Fly to Japan</button>
      <button onclick="panTo([48, 2])">Pan to Paris</button>
      <button onclick="getLocationName(37.7749, -122.4194)">Get Location Name</button>
      <button onclick="WEATHER_FORECAST_BOX_CREATE()">Show Weather Forecast</button>
    </div>
    <div id="coords">Hover your mouse over the map to get coordinates</div>
    <div id="weather-container">
      <h3>Weather Information</h3>
      <p>City: <span data-cityName>Unknown</span></p>
      <img data-countryFlag src="" alt="Country flag" />
      <p>Description: <span data-weatherDesc>Clear</span></p>
      <img data-weatherIcon src="" alt="Weather icon" />
      <p>Temperature: <span data-temp>0 °C</span></p>
      <p>Wind Speed: <span data-windspeed>0 m/s</span></p>
      <p>Humidity: <span data-humidity>0 %</span></p>
      <p>Clouds: <span data-clouds>0 %</span></p>
    </div>
  </body>
</html>
